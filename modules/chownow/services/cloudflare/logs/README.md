# Cloudflare Logs

### General

* Description: Terraform module for Cloudflare log management
* Created By: Joe Perez
* Module Dependencies: N/A
* Provider Dependencies: `aws`

### Usage

* Terraform:

```hcl
module "cloudflare_logs" {
  source = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/cloudflare/logs?ref=cn-cloudflare-logs-v2.0.1"

  env = var.env
}
```


### Options

* Description: Input variable options and Outputs for other modules to consume

#### Inputs

| Variable Name             | Description                            | Options                         |  Type   | Required? | Notes |
| :------------------------ | :------------------------------------- | :------------------------------ | :-----: | :-------: | :---- |
| abort_incomplete_days     | remove incomplete files after x days   | days                            | String  |    no     | N/A   |
| bucket_acl                | acl for s3 bucket                      |                                 | String  |    No     | N/A   |
| cf_aws_account_number     | cloudflare provided account number     | AWS Account Number              | String  |    No     | N/A   |
| cf_aws_user               | cloudflare provided username           | AWS Username                    | String  |    No     | N/A   |
| env                       | unique environment/stage name          | sandbox/dev/qa/uat/stg/prod/etc | string  |    Yes    | N/A   |
| object_expiration         | s3 objects expire/delete after x days  | days                            | String  |    No     | N/A   |
| s3_key                    | s3 folder for logs                     | (default: logs)                 | String  |    No     | N/A   |
| s3_lifecycle_rule_enabled | enables/disables s3 lifecycle rules    | true/false                      | Boolean |    No     | N/A   |
| transition_days           | transition s3 objects after x days     | days                            | String  |    No     | N/A   |
| transition_storage_class  | storage class for transitioned objects | S3 storage classes              | String  |    No     | N/A   |


#### Outputs

| Variable Name | Description           |  Type  | Notes |
| :------------ | :-------------------- | :----: | :---- |
| bucket_id     | cloudflare bucket ID  | string | N/A   |
| bucket_arn    | cloudflare bucket ARN | string | N/A   |

### Lessons Learned

* Custom lifecycle rules make it hard to re-use a pre-built s3 bucket module in this situation
* Make sure the policy that has been generated by cloudflare dashboard matches the policy generated by terraform in the aws s3 console

### References

* [Cloudflare AWS configuration](https://developers.cloudflare.com/logs/logpush/aws-s3/)
