# POS square integration service

### General

* Description: A module to POS square integration service
* Created By: Karol Kania
* Module Dependencies:
* Provider Dependencies: `aws`
* Terraform Version: 0.14.x

### Description

The goal is to implement a microservice (POS Service), which integrates third-party POS vendors (POS Vendor) with the ChowNow system.
The service will be a "proxy" between ChowNow and the selected restaurant POS vendor.
We believe that there will be one unique POS Service per POS Vendor, handling all restaurant traffic for restaurants that use that POS vendor.

### Usage

* Terraform:

* POS Square Integration Base Example (`pos_square_base.tf`):
```hcl
module "pos_square_base" {
  source = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/pos-integration-square/base?ref=pos-integration-square-v2.1.1"
  env    = var.env
  name   = "pos-square"

  subdomain_name = "pos-square"
  vpc_name_prefix = "nc"
}
```

* POS Square Integration DB Example (`pos_square_db.tf`):

* ***NOTE***: it's required to create a non-root user in the Database ***AND*** then to fill the `rds_db_details` secret with a specific JSON value; see below for more details.

```hcl
module "pos_square_db" {
  source = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/pos-integration-square/db?ref=pos-integration-square-v2.1.1"
  env    = var.env
  name   = "pos-square"

  subdomain_name = "pos-square"
  vpc_name_prefix = "nc"

  rds_instance_class = "db.t3.small"
  ec_rg_node_type = "cache.t2.micro"
}
```
* POS Square Integration App Example (`main.tf`):
```hcl
module "pos_square_app_base" {
  source = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/pos-integration-square/app_base?ref=pos-integration-square-v2.1.1"

  env      = var.env
  env_inst = var.env_inst

  name = "pos-square"

  subdomain_name  = "pos-square"
  vpc_name_prefix = "nc"
}
```

* POS Square Integration App Example (`pos_square_app.tf`):
```hcl
module "pos_square_app" {
  source    = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/pos-integration-square/app?ref=pos-integration-square-v2.1.1"
  env       = var.env
  name      = "pos-square"
  image_uri = format("%s.dkr.ecr.us-east-1.amazonaws.com/pos-square-chalice:731793ba-20220131T125723", var.aws_account_id)

  pos_vendor_oauth_client_id  = "sandbox-sq0idb-5Me3xzvO1JYfEMKK5U9Vkw"
  powertools_logger_log_event = "True" # can reveal sensitive info in logs / datadog
  debug                       = "True"
  log_level                   = "DEBUG"
  mocked_pos_vendor_api       = "False"
  pos_vendor_is_sandbox       = "True"
  pos_vendor_api_url          = "https://connect.squareupsandbox.com"
  sf_api_is_sandbox           = "True"
  sf_api_username             = "pos-integrationuser@chownow.com.cnfull"
  hermosa_dashboard_url       = "https://app-dashboard.qa.svpn.chownow.com"

  subdomain_name  = "pos-square"
  vpc_name_prefix = "nc"

  lambda_tracing_enabled        = true
  stepfunctions_tracing_enabled = true
}
```

_Note:_
  - be sure to update the `Lambda's image_uri` tag with a valid tag, otherwise the lambda creation will fail_
  - docker image must be pushed to ECR prior to creating / updating the Lambda setup

### Initialization

### Terraform

* Example directory structure:
```
├── env_global.tf
├── global
└── us-east-1
    ├── api-gateway
    ├── base
    ├── core
    ├── db
    └── services
        └── pos-integration-square
            ├── app
            │   ├── env_global.tf -> ../../../../env_global.tf
            │   ├── pos_square_app.tf
            │   └── provider.tf
            ├── base
            │   ├── env_global.tf -> ../../../../env_global.tf
            │   ├── pos_square_base.tf
            │   └── provider.tf
            └── db
                ├── env_global.tf -> ../../../../env_global.tf
                ├── pos_square_db.tf
                └── provider.tf
```
## Deployment sequence with dependencies

### Config files (API Gateway & Step Functions)

There are a couple of files stored in `app/templates/` that are used to configure the following:

(these are actually templates, one should replace the Lambda ARNs in order to make them parsed and applicable by AWS Resources)

- `apigw.*.json` - used as a API GW definition, this is automatically generated by the framework used by the app (Chalice)
  - this makes the API Gateway setup a lot easier to maintain
  - requires the Lambda's aliased invoke function ARNs since the API lambda is configured with preprovisioning on top of aliased for a version published with every update -- `module.lambda_api.lambda_function_invoke_arn_alias_newest`
  - example: `arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:123456789012:function:pos-square-integration-api-qa:newest/invocations`
- `*.asl.json` - used as a Step Functions State Machine definition (ASL stands for Amazon States Language)
  - requires the ARN of the resource to execute
  - example: `arn:aws:lambda:us-east-1:123456789012:function:FUNCTION_NAME`

Both files are attached to each [POS-Square release](https://github.com/ChowNow/pos-square/releases) after it's published

### Database

#### Initialization

* ssh/ssm into ec2 instance in the same VPC
  * Take a look at the jumpbox module
* Verify network connectivity to postgres database: `nc -zv service-db-primary.qa.aws.chownow.com 5432` (change `service` to actual service name)
* Create new user: `createuser -h service-db-primary.qa.aws.chownow.com -U root -W -dPE service` (change `service` to the actual service name)
  * Enter service password twice
  * Enter root password to authenticate
* Verify `psql` connectivity: `psql -U service -h service-db-primary.qa.aws.chownow.com -d service` (change `service` to the actual service name)

#### DB_DETAILS secret format

In order to avoid using the root credentials for production app and to simplify the application's db user password rotation,
there is a secret created: `rds_db_details` that should follow the JSON structure as defined in the [documentation](https://docs.aws.amazon.com/secretsmanager/latest/userguide/reference_secret_json_structure.html#reference_secret_json_structure_rds-postgres)

I created a dedicated `posuser` in the PostgreSQL DB (1password entries in place, under `[ENV] Aurora PostgreSQL` > `NON-ROOT USER` -- `Netguru POS` vault).

This is a single secret that is used by both: the app and the sql proxy so it's just one secret to update (plus the password for the `posuser` role in the PostgreSQL Database itself when the rotation occurs)

- For the sake of the sql proxy - it just needs `user` and `password` keys from that structure (in order to be able to authenticate to the target DB, and that target DB is declared in the Terraform code).
- For the sake of the app - it needs all the keys from the JSON structure (the app builds the `DATABASE_URL` based on that input) - please ***NOTE*** that the `db_host` in the secret should point to `proxy`, NOT the `target db cluster`.

Initial setup requires it to be specified manually first.

```json
 {
  "engine": "postgresql+psycopg2",
  "host": "<instance host name/resolvable DNS name -- this should point to the proxy host, not the target DB host>",
  "username": "<username>",
  "password": "<password>",
  "dbname": "<database name. If not specified, defaults to 'postgres'>",
  "port": "<TCP port number. If not specified, defaults to 5432>"
 }
```

### Terraform

* In new environment:
  * [all] `us-east-1/services/pos-integration-square/base`
  * [all] AWS Secrets Manager: Update secrets values with values from 1Password:
    - `SENTRY_URL` -- used to connect to Sentry API
    - `POS_VENDOR_OAUTH_CLIENT_SECRET` -- used to connect to POS SQUARE API
    - `SF_API_PASSWORD` -- used to connect to SalesForce API
    - `SF_API_SECURITY_TOKEN` -- used to connect to SalesForce API
    - `POS_VENDOR_WEBHOOK_SIGNATURE_KEY` -- used to validate POS SQUARE WEBHOOK Signature
    - `STEAKS_WEBHOOK_URL_ARN_SECRET_KEY` -- Slack webhook
  * [all] `us-east-1/services/pos-integration-square/db`
  * [all] `us-east-1/services/pos-integration-square/app`

### Lessons Learned
