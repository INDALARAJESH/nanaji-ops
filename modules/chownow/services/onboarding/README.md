# Onboarding service

### General

* Description: A module for onboarding service
* Created By: Serge Makovsky
* Module Dependencies:
* Provider Dependencies: `aws`
* Terraform Version: 0.14.x

### Description

The Onboarding Service will eventually be the source of truth for restaurant data BEFORE a restaurant goes live on ChowNow’s platform. All restaurant onboarding flows would eventually be handled by this service including but not limited to:
- Dashboard Self-Serve Onboarding Wizard
- API Driven Workflows
- Future Mass / Partnership Onboarding Requirements

### Usage

* Terraform:

* Onboarding Service Base Example (`onboarding_base.tf`):

```hcl
module "onboarding_base" {
  source          = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/onboarding/base?ref=onboarding-base-v2.0.4"
  env             = var.env
  name            = "onboarding"
  vpc_name_prefix = "nc"
}
```

* Onboarding Service App Example (`onboarding_app.tf`):

```hcl
module "onboarding_app" {
  source    = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/onboarding/app?ref=onboarding-app-v2.0.37"
  env       = var.env
  name      = "onboarding"
  image_uri = format("%s.dkr.ecr.us-east-1.amazonaws.com/onboarding:731793ba-20220131T125723", var.aws_account_id)

  powertools_logger_log_event = "True" # can reveal sensitive info in logs / datadog
  debug                       = "True"
  log_level                   = "DEBUG"
  vpc_name_prefix = "nc"
  lambda_tracing_enabled        = true
  stepfunctions_tracing_enabled = true
}
```

* Onboarding Service DB Example (`onboarding_db.tf`):

```hcl
module "onboarding_db" {
  source = "git::git@github.com:ChowNow/ops-tf-modules.git//modules/chownow/services/onboarding/db?ref=onboarding-db-v2.0.29"
  env = var.env
}
```

_Note:_
  - Be sure to update the `Lambda's image_uri` tag with a valid tag, otherwise the lambda creation will fail
  - Docker image must be pushed to ECR prior to creating / updating the Lambda setup

### Initialization

### Terraform

* Example directory structure:
```
├── env_global.tf
├── global
└── us-east-1
    ├── api-gateway
    ├── base
    ├── core
    ├── db
    └── services
        └── onboarding
            ├── app
            │   ├── env_global.tf -> ../../../../env_global.tf
            │   ├── onboarding_app.tf
            │   └── provider.tf
            ├── base
            │   ├── env_global.tf -> ../../../../env_global.tf
            │   ├── onboarding_base.tf
            │   └── provider.tf
            ├── db
            │   ├── env_global.tf -> ../../../../
            │   ├── onboarding_db.tf
            │   └── provider.tf
```

## Deployment sequence with dependencies

### Config files (API Gateway & Step Functions)

There are a couple of files stored in `app/templates/` that are used to configure the following:

(these are actually templates, one should replace the Lambda ARNs in order to make them parsed and applicable by AWS Resources)

- `apigw.*.json` - used as a API GW definition, this is automatically generated by the framework used by the app (Chalice)
  - this makes the API Gateway setup a lot easier to maintain
  - requires the Lambda's aliased invoke function ARNs since the API lambda is configured with preprovisioning on top of aliased for a version published with every update -- `module.lambda_api.lambda_function_invoke_arn_alias_newest`

- `*.asl.json` - used as a Step Functions State Machine definition (ASL stands for Amazon States Language)
  - requires the ARN of the resource to execute
  - example: `arn:aws:lambda:us-east-1:123456789012:function:FUNCTION_NAME`

Both files are attached to each [Onboarding Service release](https://github.com/ChowNow/onboarding/releases) after it's published

### Terraform

* In new environment:
  * [all] `us-east-1/services/onboarding/base`
  * [all] AWS Secrets Manager: Update secrets values with values from 1Password:
    - `SENTRY_URL` -- used to connect to Sentry API
    - `SF_API_PASSWORD` -- used to connect to SalesForce API
    - `SF_API_SECURITY_TOKEN` -- used to connect to SalesForce API
  * [all] `us-east-1/services/onboarding/app`

### Lessons Learned
